<!DOCTYPE html>
<html lang="en" id="htmlId"
      onselectstart="return false" onpaste="return false;" onCopy="return false" onCut="return false"
      onDrag="return false" onDrop="return false" autocomplete=off unselectable="on">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=10.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <script src="js/languages/languages.js"></script>
  <script src="js/mOperators/mOperators.js"></script>
  <!-- CSS -->

  <!-- JS COMMON -->
  <!-- @include(cordova.htmlinc) -->
  <script src="lib/js/riot.js"></script>
  <script src="lib/js/all.js"></script>


  <script src="js/encryption/sha512.js"></script>
  <script src="js/encryption/md5.js"></script>
  <script src="js/api/WebApi.js"></script>
  <script src="js/globalObjects/global.Objects.js"></script>

  <!--Resize Image-->
  <script src="js/resizeImage/ImageTools.js"></script>

  <!--Chart Library-->
  <script src="js/chart/Chart.js"></script>


</head>

<body id="bodyId">
<component-notification id="notificationPushId">
</component-notification>

<div id="riotTags">
</div>

<script>

  api.init();
  scope = this;

  permissionAccess = function () {

    var permissions = cordova.plugins.permissions;
    permissions.checkPermission(permissions.READ_PHONE_STATE, checkPermissionCallbackOfSim, null);
    permissions.checkPermission(permissions.CALL_PHONE, checkPermissionCallbackOfCall, null);
    window.plugins.sim.getSimInfo(successOfSim, errorOfSim);

    function successOfSim(success) {
      console.log(success)
    }

    function errorOfSim(error) {
      console.log(error)
    }

    function checkPermissionCallbackOfSim(status) {
      if (!status.checkPermission) {
        var errorCallback = function () {
          console.log('SIM permission is not turned on');
        }
        permissions.requestPermission(
          permissions.READ_SMS,
          function (status) {
            if (!status.checkPermission) errorCallback();
          },
          errorCallback);
      }
    }

    function checkPermissionCallbackOfCall(status) {
      if (!status.checkPermission) {
        var errorCallback = function () {
          console.log('CALL permission is not turned on');
        }
        permissions.requestPermission(
          permissions.CALL_PHONE,
          function (status) {
            if (!status.checkPermission) errorCallback();
          },
          errorCallback);
      }
    }

    window.FirebasePlugin.hasPermission(function (data) {
      console.log('FIREBASE ACCESS', data.isEnabled);
    });

  }

  if (window.cordova) {
    document.addEventListener("deviceready", function () {

      if (!window.isConnected) {
        var options = {dimBackground: true};

        SpinnerPlugin.activityStart(languages.ConnectionSocket, options, function () {
          console.log("Started");
        }, function () {
          console.log("closed");
        });
      }

      window.FirebasePlugin.subscribe("Click");

      var numberOfMessage = 0;
      window.FirebasePlugin.onNotificationOpen(function (notification) {
        console.log("PUSH NOTIFICATION OBJECT", notification);
        ++numberOfMessage;

        window.FirebasePlugin.setBadgeNumber(numberOfMessage);

      }, function (error) {
        console.error(error);
      });


      if (!localStorage.getItem('settings_block')) {
        localStorage.setItem('click_client_block', false)
      }

      localStorage.setItem('onResume', false);

      StatusBar.backgroundColorByHexString("#00a8f1");

      if (device.platform == 'Android')
        permissionAccess();

      var GENERATOR = document.createElement('script');
      GENERATOR.src = 'js/cssGenerator/Css.Generator.js';
      document.head.appendChild(GENERATOR);

      firstMount.firstStep = function () {
        if (localStorage.getItem('click_client_token') && JSON.parse(localStorage.getItem('confirm_needed')) !== true && JSON.parse(localStorage.getItem('click_client_registered')) === true) {
          scope.riotTags.innerHTML = "<view-authorization>";
          riot.mount('view-authorization')
        }
        else {
          scope.riotTags.innerHTML = "<view-registration-device>";
          riot.mount('view-registration-device');
        }
      }

      document.addEventListener("backbutton", onBackKeyDown, false);
      document.addEventListener("pause", onPauseFunction, false);
      document.addEventListener("resume", onResumeFunction, false);
    }, false);
  }

  //  if (JSON.parse(localStorage.getItem('demo_version')) === true) {
  //    this.closeDemo();
  //  }

  function onBackKeyDown() {
    history.arrayOfHistory = JSON.parse(sessionStorage.getItem('history'));

    if (history.arrayOfHistory.length != 0) {
      if (history.arrayOfHistory[history.arrayOfHistory.length - 1].view == 'view-main-page'
        || history.arrayOfHistory[history.arrayOfHistory.length - 1].view == 'view-registration-device'
        || history.arrayOfHistory[history.arrayOfHistory.length - 1].view == 'view-authorization'
        || history.arrayOfHistory[history.arrayOfHistory.length - 1].view == 'view-registration-client') {
        navigator.app.exitApp();
      }
      else {
        history.arrayOfHistory.pop();
        sessionStorage.setItem('history', JSON.stringify(history.arrayOfHistory));
        riotTags.innerHTML = "<" + history.arrayOfHistory[history.arrayOfHistory.length - 1].view + ">";
        riot.mount(history.arrayOfHistory[history.arrayOfHistory.length - 1].view, history.arrayOfHistory[history.arrayOfHistory.length - 1].params);

      }

    }

  }

  function onPauseFunction() {
    if (componentMenu.check === true || window.pickContactFromNativeChecker === true) {
      window.pickContactFromNativeChecker = false;
      componentMenu.check = false;
      return
    }
    setTimeout(function () {

      console.log('ON onResume EVENT IS TRIGGERED')
      localStorage.setItem('onResume', true);
      if (JSON.parse(localStorage.getItem('settings_block')) === true) {
        riotTags.innerHTML = "<view-authorization>";
        riot.mount('view-authorization');
      }
    }, 0);
  }

  function onResumeFunction() {
    setTimeout(function () {
    }, 0);
  }


  function checkImageURL(dirEntry, fileNamePrefix, fileName, assetURL, index, callback) {

    var xhr = new XMLHttpRequest();

    xhr.open('GET', cordova.file.applicationDirectory + dirEntry + fileName, true);
    xhr.responseType = 'blob';

    xhr.onload = function () {
//      console.log("in onload");

      var blob = new Blob([this.response], {type: 'image/png'});
//      console.log("status 200 For " + fileName);
      //object[fieldName] = cordova.file.applicationDirectory + dirEntry + fileName;
      callback(false, index, fileName);

//      if (this.status == 200) {
//
//        var blob = new Blob([this.response], {type: 'image/png'});
//        console.log("status 200 For " + fileName);
//        //object[fieldName] = cordova.file.applicationDirectory + dirEntry + fileName;
//        callback(false, index, fileName);
//      }
    };

    xhr.onerror = function () {
//      console.log("error for " + fileName);

      var convertFunction = convertFileToDataURLviaFileReader;

      convertFunction(assetURL, function (base64Img) {
//        console.log("base64 length=" + base64Img.length);
        // Split the base64 string in data and contentType
        var block = base64Img.split(";");
        // Get the content type
        var dataType = block[0].split(":")[1];// In this case "image/png"
        // get the real base64 content of the file
        var realData = block[1].split(",")[1];// In this case "iVBORw0KGg...."

        var folderpath = cordova.file.dataDirectory;

        savebase64AsImageFile(folderpath, fileNamePrefix + fileName, realData, dataType);

        callback(true, index, fileNamePrefix + fileName);
      });
      event.preventDefault();
    };
    xhr.send();
  }


  function savebase64AsImageFile(folderpath, filename, content, contentType) {
    // Convert the base64 string in a Blob
    var DataBlob = b64toBlob(content, contentType);

//    console.log("Starting to write the file :3");

    window.resolveLocalFileSystemURL(folderpath, function (dir) {
//      console.log("Access to the directory granted succesfully");
      dir.getFile(filename, {create: true, exclusive: false}, function (file) {
//        console.log("File created succesfully.");
        file.createWriter(function (fileWriter) {
          ("Writing content to file");
          fileWriter.write(DataBlob);
        }, function () {
          alert('Unable to save file in path ' + folderpath);
        });
      });
    });
  }

  function b64toBlob(b64Data, contentType, sliceSize) {
    contentType = contentType || '';
    sliceSize = sliceSize || 512;

    var byteCharacters = atob(b64Data);
    var byteArrays = [];

    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      var slice = byteCharacters.slice(offset, offset + sliceSize);

      var byteNumbers = new Array(slice.length);
      for (var i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }

      var byteArray = new Uint8Array(byteNumbers);

      byteArrays.push(byteArray);
    }

    var blob = new Blob(byteArrays, {type: contentType});
    return blob;
  }

  function convertFileToDataURLviaFileReader(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.onload = function () {
      var reader = new FileReader();
      reader.onloadend = function () {
        callback(reader.result);
      }
      reader.readAsDataURL(xhr.response);
    };
    xhr.open('GET', url);
    xhr.responseType = 'blob';
    xhr.send();
  }


  function onErrorLoadFs() {
    alert("OnErrorLoadFS");
  }


</script>
</body>
</html>
