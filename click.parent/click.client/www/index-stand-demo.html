<!DOCTYPE html>
<html lang="en" id="htmlId"
      onselectstart="return false" onCopy="return false" onCut="return false"
      onDrag="return false" onDrop="return false" autocomplete=off unselectable="on">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <script src="js/languages/languages.js"></script>
  <script src="js/mOperators/mOperators.js"></script>
  <!-- CSS -->

  <script src="stand/plugins/sms_fake.js"></script>
  <script src="stand/plugins/plugins_fake.js"></script>

  <!--JS COMMON -->
  <!--@include(cordova.htmlinc)-->
  <script src="lib/js/riot.js"></script>
  <script src="lib/js/all.js"></script>

  <!--Encryption-->
  <script src="js/encryption/sha512.js"></script>
  <script src="js/encryption/md5.js"></script>

  <!--RealApi-->
  <script src="js/api/WebApi.js"></script>
  <script src="js/globalObjects/global.Objects.js"></script>
  <script src="js/offlineMode/offlineModeVariables.js"></script>

  <!-- FAKES -->
  <script src="stand/fakedSocket.js"></script>
  <script src="stand/allMethods.js"></script>

</head>

<body id="bodyId">
<div id="riotTags" class="riotTags">
  <view-main-page></view-main-page>
</div>


<script>

  api.init();
  scope = this;

  if (window.cordova) {
    document.addEventListener("deviceready", function () {

      if (device.platform == 'Android')
        permissionAccess();

      var GENERATOR = document.createElement('script');
      GENERATOR.src = 'js/cssGenerator/Css.Generator.js';
      document.head.appendChild(GENERATOR);


      firstMount.firstStep = function () {
        prepareLoginData();
      };

      document.addEventListener("backbutton", onBackKeyDown, false);
    }, false);
  }
  else {
    var GENERATOR = document.createElement('script');
    GENERATOR.src = 'js/cssGenerator/Css.Generator.js';
    document.head.appendChild(GENERATOR);

    firstMount.firstStep = function () {
      prepareLoginData();

    }
  }


  //  if (JSON.parse(localStorage.getItem('demo_version')) === true) {
  //    this.closeDemo();
  //  }

  function prepareLoginData() {
    var phoneNumber = "998901111111";
    localStorage.setItem('click_client_phoneNumber', phoneNumber);
    var date = parseInt(Date.now() / 1000);
    var deviceId = "9989094641336AC091D93CD5E";
    localStorage.setItem('click_client_deviceID', deviceId);
    token = hex_sha512(deviceId + date + phoneNumber);
    localStorage.setItem('click_client_token', token);
    pin = '11111';
    var password = hex_sha512(token + date + hex_md5(pin));
    localStorage.setItem("pinForStand", pin);
    var JsonInfo = {
      "session_key": "99890988081996E4e71383c9ed9b1a3fb05fb0002499744",
      "language": "RU",
      "default_account": "3487271",
      "visibility": false,
      "help_status": false,
      "firstname": "Test",
      "lastname": "Testov",
      "gender": "F",
      "profile_image_url": null,
      "update_categories": false,
      "update_services": true,
      "update_faq": false,
      "update_terms": true,
      "p2p_comission": 2
    };
    localStorage.setItem('click_client_loginInfo', JSON.stringify(JsonInfo));
    localStorage.setItem('demo_version', true);
    localStorage.setItem('myNumberOperatorId', "3");
    getAccount();
    //getLists();

  }


  var arrayAccountInfo = [];
  getAccount = function (e) {
    console.log("in getAccounts");
    if (JSON.parse(localStorage.getItem("click_client_loginInfo"))) {
      var phoneNumber = localStorage.getItem("click_client_phoneNumber");
      var info = JSON.parse(localStorage.getItem("click_client_loginInfo"));
      var sessionKey = info.session_key;

      console.log("in getAccounts 2");


      if (!localStorage.getItem("click_client_accountInfo")) {
        window.api.call({
          method: 'get.accounts',
          input: {
            session_key: sessionKey,
            phone_num: phoneNumber
          },

          scope: this,

          onSuccess: function (result) {

            if (result[0][0].error == 0) {

              if (device.platform != 'BrowserStand') {
                window.requestFileSystem(window.TEMPORARY, 1000, function (fs) {
                  var j = -1;
                  for (var i = 0; i < result[1].length; i++) {

                    j++;
                    arrayAccountInfo.push(result[1][i]);

                    var icon = result[1][i].card_background_url;
                    console.log();
                    var filename = icon.substr(icon.lastIndexOf('/') + 1);
                    console.log("filename=" + filename);

                    var newIconBool = checkImageURL;
                    newIconBool('www/resources/icons/cards/', 'cards', filename, icon, j, function (bool, index, fileName) {

                      if (bool) {
                        arrayAccountInfo[index].card_background_url = cordova.file.dataDirectory + fileName;
                      } else {
                        arrayAccountInfo[index].card_background_url = url('resources/icons/cards/' + fileName);
                      }

                      var icon2 = arrayAccountInfo[index].image_url;
                      var filename2 = icon2.substr(icon2.lastIndexOf('/') + 1);
                      var newIcon = checkImageURL;
                      newIcon('www/resources/icons/cards/logo/', 'logo', filename2, icon2, index, function (bool2, index2, fileName2) {

                        if (bool2) {
                          arrayAccountInfo[index2].image_url = cordova.file.dataDirectory + fileName2;
                        } else {
                          arrayAccountInfo[index2].image_url = url('resources/icons/cards/logo/' + fileName2);
                        }

                        if (result[1].length == arrayAccountInfo.length) {
                          console.log("GHVCHGFUIHOI:JIJsave into localstorage");
                          var accountInfo = JSON.stringify(arrayAccountInfo);
                          localStorage.setItem("click_client_accountInfo", accountInfo);
                          this.riotTags.innerHTML = "<view-main-page>";
                          riot.mount('view-main-page');
                        }
                      });

                    });

                  }
                }, onErrorLoadFs);
              } else {
                for (var i = 0; i < result[1].length; i++)
                  arrayAccountInfo.push(result[1][i])
                var accountInfo = JSON.stringify(arrayAccountInfo);
                localStorage.setItem("click_client_accountInfo", accountInfo);
                this.riotTags.innerHTML = "<view-main-page>";
                riot.mount('view-main-page');
              }
            }
            else
              alert(result[0][0].error_note);
          },


          onFail: function (api_status, api_status_message, data) {
            console.error("api_status = " + api_status + ", api_status_message = " + api_status_message);
            console.error(data);
          }
        })
      } else {
        this.riotTags.innerHTML = "<view-main-page>";
        riot.mount('view-main-page');
      }
    }
  }


  function onBackKeyDown() {
    alert("in onKeyBack");
    history.arrayOfHistory = JSON.parse(sessionStorage.getItem('history'));

    if (history.arrayOfHistory.length != 0) {
      if (history.arrayOfHistory[history.arrayOfHistory.length - 1].view == 'view-main-page') {

        localStorage.clear();

        window.location.href = "index.html";
        //navigator.app.exitApp();
      }
      else {
        history.arrayOfHistory.pop();
        sessionStorage.setItem('history', JSON.stringify(history.arrayOfHistory));
        riotTags.innerHTML = "<" + history.arrayOfHistory[history.arrayOfHistory.length - 1].view + ">";
        console.log(history.arrayOfHistory[history.arrayOfHistory.length - 1].view)
        console.log(history.arrayOfHistory[history.arrayOfHistory.length - 1].params)
        riot.mount(history.arrayOfHistory[history.arrayOfHistory.length - 1].view, history.arrayOfHistory[history.arrayOfHistory.length - 1].params);

      }
    }
  }

  window.beforeunload = function (e) {
    alert("vrflibkvp;ae");
    //    return 'Dialog text here.';
  };
  //
  //  $(window.location).trigger(
  //    "change",
  //    {
  //      currentHref: strLocation,
  //      currentHash: fnCleanHash(strHash),
  //      previousHref: strPrevLocation,
  //      previousHash: fnCleanHash(strPrevHash)
  //    }
  //  );

  $(window.location).bind(
    "change",
    function (objEvent, objData) {
      alert("YKJJJJ");
      var jLog = $("#log");
      // Add the URL change.
      jLog.append(
        "<li>" +
        "Hash changed from " +
        "<strong>" + objData.previousHash + "</strong>" +
        " to " +
        "<strong>" + objData.currentHash + "</strong>" +
        "</li>"
      );
    }
  );


  scope.categoryList = JSON.parse(localStorage.getItem("click_client_payCategoryList"));
  scope.serviceList = JSON.parse(localStorage.getItem("click_client_payServiceList"));
  scope.serviceNamesMap = JSON.parse(localStorage.getItem("click_client_payServiceNamesMap"));
  scope.servicesMapByCategory = JSON.parse(localStorage.getItem("click_client_servicesMapByCategory"));
  scope.servicesMap = JSON.parse(localStorage.getItem("click_client_servicesMap"));
  scope.servicesParams = JSON.parse(localStorage.getItem("click_client_servicesParams"));
  scope.servicesParamsMapOne = JSON.parse(localStorage.getItem("click_client_servicesParamsMapOne"));


  var phoneNumber = localStorage.getItem('click_client_phoneNumber');
  scope.operatorKey = phoneNumber.substr(3, 2);
  phoneNumber = phoneNumber.substring(3, phoneNumber.length);

  var sessionKey = JSON.parse(localStorage.getItem('click_client_loginInfo')).session_key;

  //  if (!localStorage.getItem("click_client_payCategoryList")) {
  scope.categoryList = [];
  scope.categoryNamesMap = {};
  window.api.call({
    method: 'get.service.category.list',
    input: {
      session_key: sessionKey,
      phone_num: phoneNumber
    },
    scope: this,

    onSuccess: function (result) {
      if (result[0][0].error == 0)
        if (result[1][0]) {

          if (device.platform != 'BrowserStand') {
            window.requestFileSystem(window.TEMPORARY, 1000, function (fs) {
              var j = -1;

              for (var i in result[1]) {

                scope.categoryNamesMap[result[1][i].id] = {
                  "name": result[1][i].name,
                  "icon": result[1][i].icon
                };
                j++;
                scope.categoryList.push(result[1][i]);

                var icon = result[1][i].icon;
                var filename = icon.substr(icon.lastIndexOf('/') + 1);

                var newIconBool = checkImageURL;
                newIconBool('www/resources/icons/ViewPay/', 'ViewPay', filename, icon, j, function (bool, index, fileName) {

                  if (bool) {
                    scope.categoryList[index]['icon'] = cordova.file.dataDirectory + fileName;//
                  } else {
                    scope.categoryList[index]['icon'] = 'resources/icons/ViewPay/' + fileName;
                  }

                  if (result[1].length == scope.categoryList.length) {
//                            console.log("save into localstorage, categoryList=", scope.categoryList);
                    scope.update(scope.categoryList);
                    localStorage.setItem('click_client_payCategoryList', JSON.stringify(scope.categoryList));
                    localStorage.setItem('click_client_categoryNamesMap', JSON.stringify(scope.categoryNamesMap));
                  }
                });
              }
            }, onErrorLoadFs);
          }
          else {
            for (var i in result[1]) {

              scope.categoryList.push(result[1][i]);
              scope.categoryNamesMap[result[1][i].id] = {
                "name": result[1][i].name,
                "icon": result[1][i].icon
              };
            }
//                    riot.update(scope.categoryList);
            localStorage.setItem('click_client_payCategoryList', JSON.stringify(scope.categoryList));
            localStorage.setItem('click_client_categoryNamesMap', JSON.stringify(scope.categoryNamesMap));
          }
        }

      scope.id = 0;

    },
    onFail: function (api_status, api_status_message, data) {
      console.error("api_status = " + api_status + ", api_status_message = " + api_status_message);
      console.error(data);
    }
  });
  //  }

  //  refreshServiceList = function () {
  //          console.log("IN SERVICE LIST FUNC");
  scope.serviceList = [];
  scope.servicesMapByCategory = {};
  scope.servicesMap = {};
  scope.serviceNamesMap = {};
  scope.operatorKey = phoneNumber.substr(3, 2);
  //          console.log("MOPERATORS!!!!!!!!!!!!!!", window.mOperators[scope.operatorKey]);
  window.api.call({
    method: 'get.service.list',
    input: {
      session_key: sessionKey,
      phone_num: phoneNumber
    },
    scope: this,

    onSuccess: function (result) {
      if (result[0][0].error == 0)
        if (result[1][0]) {

          var firstService;

          if (device.platform != 'BrowserStand') {
            window.requestFileSystem(window.TEMPORARY, 1000, function (fs) {
              var inVisibleNum = 0, j = -1;

              for (var i in result[1]) {
                if (result[1][i].is_visible == 1) {

                  console.log("service id=", result[1][i].id, ", element:", result[1][i]);

                  scope.serviceNamesMap[result[1][i].id] = result[1][i].name;
                  j++;
                  scope.serviceList.push(result[1][i]);

                  var icon = result[1][i].image;
                  var filename = icon.substr(icon.lastIndexOf('/') + 1);

                  var newIconBool = checkImageURL;
                  newIconBool('www/resources/icons/ViewPay/', 'ViewPay', filename, icon, j, function (bool, index, fileName) {

                    if (bool) {
                      scope.serviceList[index]['image'] = cordova.file.dataDirectory + fileName;//
                    } else {
                      scope.serviceList[index]['image'] = 'resources/icons/ViewPay/' + fileName;
                    }

                    if (!scope.servicesMapByCategory[scope.serviceList[index].category_id]) {
                      scope.servicesMapByCategory[scope.serviceList[index].category_id] = [];
                      if (scope.serviceList[index].category_id === 1 && (scope.serviceList[index].id === window.mOperators[scope.operatorKey])) {
                        localStorage.setItem('myNumberOperatorId', scope.serviceList[index].id);
//                                console.log("MY NUMBER ID", scope.serviceList[index].id);

                        var myNumberObject = {};
                        myNumberObject.name = 'Мой номер';
                        myNumberObject.image = 'resources/icons/ViewPay/myphone.png';
                        myNumberObject.id = 'mynumber' + scope.serviceList[index].id;
                        scope.servicesMapByCategory[scope.serviceList[index].category_id].push(myNumberObject);

                      } else if (scope.serviceList[index].category_id === 1) {
                        firstService = scope.serviceList[index];
//                                console.log("FIRST SERVICE=", firstService);
                      }
                      scope.servicesMapByCategory[scope.serviceList[index].category_id].push(scope.serviceList[index]);
                    }
                    else {
                      if (scope.serviceList[index].category_id === 1 && (scope.serviceList[index].id === window.mOperators[scope.operatorKey])) {
                        localStorage.setItem('myNumberOperatorId', scope.serviceList[index].id);
//                                console.log("MY NUMBER ID", scope.serviceList[index].id);

                        var myNumberObject = {};
                        myNumberObject.name = 'Мой номер';
                        myNumberObject.image = 'resources/icons/ViewPay/myphone.png';
                        myNumberObject.id = 'mynumber' + scope.serviceList[index].id;
                        scope.servicesMapByCategory[scope.serviceList[index].category_id][0] = myNumberObject;
                        scope.servicesMapByCategory[scope.serviceList[index].category_id].push(firstService);
                      }
                      scope.servicesMapByCategory[scope.serviceList[index].category_id].push(scope.serviceList[index]);
                    }


                    if (!scope.servicesMap[scope.serviceList[index].id + '']) {
                      scope.servicesMap[scope.serviceList[index].id + ''] = [];
                      scope.servicesMap[scope.serviceList[index].id + ''].push(scope.serviceList[index]);
                    }
                    else {
                      scope.servicesMap[scope.serviceList[index].id + ''].push(scope.serviceList[index]);
                    }


                    if ((result[1].length - inVisibleNum) == scope.serviceList.length) {
//                              console.log("save into localstorage");
                      localStorage.setItem('click_client_payServiceList', JSON.stringify(scope.serviceList));
                      localStorage.setItem('click_client_payServiceNamesMap', JSON.stringify(scope.serviceNamesMap));
                      localStorage.setItem('click_client_servicesMapByCategory', JSON.stringify(scope.servicesMapByCategory));
                      localStorage.setItem('click_client_servicesMap', JSON.stringify(scope.servicesMap));
                    }

                  });
                } else
                  inVisibleNum++;
              }
            }, onErrorLoadFs);
          } else {

            for (var i in result[1]) {
              if (result[1][i].is_visible == 1) {
//                        console.log("service id=", result[1][i].id, ", element:", result[1][i]);

                scope.serviceNamesMap[result[1][i].id] = result[1][i].name;
                scope.serviceList.push(result[1][i]);


                if (!scope.servicesMapByCategory[result[1][i].category_id]) {
                  scope.servicesMapByCategory[result[1][i].category_id] = [];
                  if (result[1][i].category_id === 1 && (result[1][i].id === window.mOperators[scope.operatorKey])) {
                    localStorage.setItem('myNumberOperatorId', result[1][i].id);
//                                console.log("MY NUMBER ID", scope.serviceList[index].id);

                    var myNumberObject = {};
                    myNumberObject.name = 'Мой номер';
                    myNumberObject.image = 'resources/icons/ViewPay/myphone.png';
                    myNumberObject.id = 'mynumber' + result[1][i].id;
                    scope.servicesMapByCategory[result[1][i].category_id].push(myNumberObject);

                  } else if (result[1][i].category_id === 1) {
                    firstService = result[1][i];
//                                console.log("FIRST SERVICE=", firstService);
                  }
                  scope.servicesMapByCategory[result[1][i].category_id].push(result[1][i]);
                }
                else {
                  if (result[1][i].category_id === 1 && (result[1][i].id === window.mOperators[scope.operatorKey])) {
                    localStorage.setItem('myNumberOperatorId', result[1][i].id);
//                                console.log("MY NUMBER ID", scope.serviceList[index].id);

                    var myNumberObject = {};
                    myNumberObject.name = 'Мой номер';
                    myNumberObject.image = 'resources/icons/ViewPay/myphone.png';
                    myNumberObject.id = 'mynumber' + result[1][i].id;
                    scope.servicesMapByCategory[result[1][i].category_id][0] = myNumberObject;
                    scope.servicesMapByCategory[result[1][i].category_id].push(firstService);
                  }
                  scope.servicesMapByCategory[result[1][i].category_id].push(result[1][i]);
                }

                ///////////////////////////////////////////////////


                if (!scope.servicesMap[result[1][i].id + '']) {
                  scope.servicesMap[result[1][i].id + ''] = [];
                  scope.servicesMap[result[1][i].id + ''].push(result[1][i]);
                }
                else {
                  scope.servicesMap[result[1][i].id + ''].push(result[1][i]);
                }
              }
            }
            localStorage.setItem('click_client_payServiceList', JSON.stringify(scope.serviceList));
            localStorage.setItem('click_client_payServiceNamesMap', JSON.stringify(scope.serviceNamesMap));
            localStorage.setItem('click_client_servicesMapByCategory', JSON.stringify(scope.servicesMapByCategory));
            localStorage.setItem('click_client_servicesMap', JSON.stringify(scope.servicesMap));

          }
        }


      servicesParamsInit();
    },
    onFail: function (api_status, api_status_message, data) {
      console.error("api_status = " + api_status + ", api_status_message = " + api_status_message);
      console.error(data);
    }
  })
  //  };


  //  servicesParamsInit = function () {
  //          console.log("IN SERVICES PARAMS INIT");
  scope.servicesParams = [];
  scope.servicesParamsMapOne = {};
  scope.servicesParamsMapTwo = {};
  scope.servicesParamsMapThree = {};
  scope.servicesParamsMapFour = {};
  scope.servicesParamsMapFive = {};
  window.api.call({
    method: 'get.service.parameters.list',
    input: {
      session_key: sessionKey,
      phone_num: phoneNumber
    },

    scope: this,

    onSuccess: function (result) {
      if (result[0][0].error == 0) {
        if (result[1])
          for (var i in result[1]) {
//                    console.log("1. service id=", result[1][i].service_id, "element:", result[1][i]);
            if (!scope.servicesParamsMapOne[result[1][i].service_id]) {
              scope.servicesParamsMapOne[result[1][i].service_id] = [];
              scope.servicesParamsMapOne[result[1][i].service_id].push(result[1][i]);
            }
            else
              scope.servicesParamsMapOne[result[1][i].service_id].push(result[1][i]);


          }
        if (result[2])
          for (var i in result[2]) {
//                    console.log("2. service id=", result[2][i].service_id, "element:", result[2][i]);
            if (!scope.servicesParamsMapTwo[result[2][i].service_id]) {
              scope.servicesParamsMapTwo[result[2][i].service_id] = [];
              scope.servicesParamsMapTwo[result[2][i].service_id].push(result[2][i]);
            }
            else
              scope.servicesParamsMapTwo[result[2][i].service_id].push(result[2][i]);

          }
        if (result[3])
          for (var i in result[3]) {
//                    console.log("3. service id=", result[3][i].service_id, "element:", result[3][i]);
            if (!scope.servicesParamsMapThree[result[3][i].service_id]) {
              scope.servicesParamsMapThree[result[3][i].service_id] = [];
              scope.servicesParamsMapThree[result[3][i].service_id].push(result[3][i]);
            }
            else
              scope.servicesParamsMapThree[result[3][i].service_id].push(result[3][i]);

          }
        if (result[4])
          for (var i in result[4]) {
//                    console.log("4. service id=", result[4][i].service_id, "element:", result[4][i]);
            if (!scope.servicesParamsMapFour[result[4][i].service_id]) {
              scope.servicesParamsMapFour[result[4][i].service_id] = [];
              scope.servicesParamsMapFour[result[4][i].service_id].push(result[4][i]);
            }
            else
              scope.servicesParamsMapFour[result[4][i].service_id].push(result[4][i]);
          }
        if (result[5])
          for (var i in result[5]) {
//                    console.log("5. service id=", result[5][i].service_id, "element:", result[5][i]);
            if (!scope.servicesParamsMapFive[result[5][i].service_id]) {
              scope.servicesParamsMapFive[result[5][i].service_id] = [];
              scope.servicesParamsMapFive[result[5][i].service_id].push(result[5][i]);
            }
            else
              scope.servicesParamsMapFive[result[5][i].service_id].push(result[5][i]);
          }
        localStorage.setItem('click_client_servicesParams', JSON.stringify(result));
        localStorage.setItem('click_client_servicesParamsMapOne', JSON.stringify(scope.servicesParamsMapOne));
        localStorage.setItem('click_client_servicesParamsMapTwo', JSON.stringify(scope.servicesParamsMapTwo));
        localStorage.setItem('click_client_servicesParamsMapThree', JSON.stringify(scope.servicesParamsMapThree));
        localStorage.setItem('click_client_servicesParamsMapFour', JSON.stringify(scope.servicesParamsMapFour));
        localStorage.setItem('click_client_servicesParamsMapFive', JSON.stringify(scope.servicesParamsMapFive));
      }
    },

    onFail: function (api_status, api_status_message, data) {
      console.error("api_status = " + api_status + ", api_status_message = " + api_status_message);
      console.error(data);
    }
  });
  //  };

  function checkImageURL(dirEntry, fileNamePrefix, fileName, assetURL, index, callback) {

    var xhr = new XMLHttpRequest();

    xhr.open('GET', cordova.file.applicationDirectory + dirEntry + fileName, true);
    xhr.responseType = 'blob';

    xhr.onload = function () {
      console.log("in onload");

      var blob = new Blob([this.response], {type: 'image/png'});
      console.log("status 200 For " + fileName);
      //object[fieldName] = cordova.file.applicationDirectory + dirEntry + fileName;
      callback(false, index, fileName);

//      if (this.status == 200) {
//
//        var blob = new Blob([this.response], {type: 'image/png'});
//        console.log("status 200 For " + fileName);
//        //object[fieldName] = cordova.file.applicationDirectory + dirEntry + fileName;
//        callback(false, index, fileName);
//      }
    };

    xhr.onerror = function () {
      console.log("error for " + fileName);

      var convertFunction = convertFileToDataURLviaFileReader;

      convertFunction(assetURL, function (base64Img) {
        console.log("base64 length=" + base64Img.length);
        // Split the base64 string in data and contentType
        var block = base64Img.split(";");
        // Get the content type
        var dataType = block[0].split(":")[1];// In this case "image/png"
        // get the real base64 content of the file
        var realData = block[1].split(",")[1];// In this case "iVBORw0KGg...."

        var folderpath = cordova.file.dataDirectory;

        savebase64AsImageFile(folderpath, fileNamePrefix + fileName, realData, dataType);

        callback(true, index, fileNamePrefix + fileName);
      });
      event.preventDefault();
    };
    xhr.send();
  }

  function savebase64AsImageFile(folderpath, filename, content, contentType) {
    // Convert the base64 string in a Blob
    var DataBlob = b64toBlob(content, contentType);

    console.log("Starting to write the file :3");

    window.resolveLocalFileSystemURL(folderpath, function (dir) {
      console.log("Access to the directory granted succesfully");
      dir.getFile(filename, {create: true, exclusive: false}, function (file) {
        console.log("File created succesfully." + filename);
        file.createWriter(function (fileWriter) {
          console.log("Writing content to file");
          fileWriter.write(DataBlob);
        }, function () {
          console.log('Unable to save file in path ' + folderpath);
        });
      });
    });
  }

  function b64toBlob(b64Data, contentType, sliceSize) {
    contentType = contentType || '';
    sliceSize = sliceSize || 512;

    var byteCharacters = atob(b64Data);
    var byteArrays = [];

    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      var slice = byteCharacters.slice(offset, offset + sliceSize);

      var byteNumbers = new Array(slice.length);
      for (var i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }

      var byteArray = new Uint8Array(byteNumbers);

      byteArrays.push(byteArray);
    }

    var blob = new Blob(byteArrays, {type: contentType});
    return blob;
  }

  function convertFileToDataURLviaFileReader(url, callback) {
    console.log("in convert!");
    var xhr2 = new XMLHttpRequest();
    xhr2.open('GET', url, true);
    xhr2.responseType = 'blob';

    xhr2.onload = function () {
      console.log("in another onload 1");
      var reader = new FileReader();
      reader.onloadend = function () {
        console.log("in another onload 2");
        callback(reader.result);
      };
      reader.readAsDataURL(xhr2.response);
    };

    xhr2.onerror = function () {
      alert("Возможно у вас нет интернета, проверьте подключение.");
    }

    xhr2.send();
  }

  function onErrorLoadFs() {
    console.log("OnErrorLoadFS");
  }

</script>
</body>
</html>
